# PhoneAgent 实现路线图

> 从玩具项目到生产可用系统的升级指南

## 🎯 目标

将 PhoneAgent 从当前的"高级原型"状态提升为"生产就绪"的 Android 自动化平台。

---

## 📊 当前状态

| 维度 | 当前 | 目标 |
|------|------|------|
| 核心功能 | 80% | 95% |
| 代码质量 | 70% | 90% |
| 测试覆盖 | 5% | 60% |
| 文档完善 | 75% | 90% |
| 生产就绪 | 50% | 90% |

---

## Phase 1: 代码清理与稳定化 (第 1-2 周)

### 1.1 移除/废弃不稳定模块

**问题**: XML Kernel 和混合模式增加复杂性但稳定性不足

**行动**:
- [ ] 在 `phone_agent/kernel/xml_agent.py` 添加废弃警告
- [ ] 在 `phone_agent/kernel/hybrid_agent.py` 添加废弃警告  
- [ ] 简化 `server/services/agent_service.py`，移除 XML/Hybrid 分支
- [ ] 更新文档，明确推荐 Vision Agent

**理由**: Vision Agent 是最稳定的执行方式，用户不需要在多种模式间选择

### 1.2 统一代码风格

**行动**:
- [ ] 运行 `black` 格式化所有 Python 代码
- [ ] 运行 `ruff` 修复 lint 问题
- [ ] 统一日志格式 (结构化 JSON)
- [ ] 统一异常处理方式

### 1.3 清理冗余代码

**行动**:
- [ ] 移除注释掉的废弃代码
- [ ] 合并重复的工具函数
- [ ] 清理未使用的导入

---

## Phase 2: 测试与质量保障 (第 2-4 周)

### 2.1 单元测试

**目标覆盖率**: 60%

**优先级**:
1. `phone_agent/model/client.py` - 模型调用逻辑
2. `phone_agent/actions/handler.py` - 动作解析与执行
3. `phone_agent/adb/*.py` - ADB 操作封装
4. `server/services/agent_service.py` - 任务管理

### 2.2 集成测试

**行动**:
- [ ] 端到端任务执行测试 (Mock ADB)
- [ ] WebSocket 通信测试
- [ ] API 接口测试

### 2.3 持续集成

**行动**:
- [ ] 配置 GitHub Actions
  - 代码格式检查
  - 单元测试
  - 安全扫描 (CodeQL)
- [ ] 添加 pre-commit hooks

---

## Phase 3: 成本优化 (第 4-6 周)

### 3.1 任务预处理优化

**当前问题**: 所有任务都调用 AI 模型，成本高

**优化方案**:

```python
# 扩展规则引擎，覆盖更多简单任务
DIRECT_ACTIONS = {
    # 系统操作
    "返回主页": "home",
    "返回": "back", 
    "截图": "screenshot",
    
    # 应用启动
    "打开设置": "launch:com.android.settings",
    "打开微信": "launch:com.tencent.mm",
    "打开抖音": "launch:com.ss.android.ugc.aweme",
    
    # 快捷操作
    "亮度最高": "brightness:255",
    "静音": "volume:0",
}
```

**预期效果**: 减少 20-30% 的 AI 调用

### 3.2 模型选择策略

**行动**:
- [ ] 实现任务复杂度评估
- [ ] 简单任务使用免费/低成本模型 (glm-4.6v-flash)
- [ ] 复杂任务使用高性能模型 (glm-4.6v)

### 3.3 缓存机制

**行动**:
- [ ] 应用包名映射缓存
- [ ] 常见任务执行路径缓存
- [ ] 屏幕元素识别缓存

---

## Phase 4: 可观测性 (第 6-8 周)

### 4.1 结构化日志

**当前问题**: 日志格式混乱，难以分析

**目标格式**:
```json
{
  "timestamp": "2025-01-01T12:00:00Z",
  "level": "INFO",
  "logger": "phone_agent.agent",
  "task_id": "abc-123",
  "device_id": "device_6100",
  "step": 3,
  "action": "tap",
  "coordinates": [500, 800],
  "duration_ms": 150,
  "message": "Executed tap action"
}
```

### 4.2 指标监控

**行动**:
- [ ] 添加 Prometheus 指标端点
- [ ] 关键指标:
  - 任务成功率
  - 平均执行时间
  - Token 消耗
  - 设备在线率
  - API 响应时间

### 4.3 链路追踪

**行动**:
- [ ] 集成 OpenTelemetry
- [ ] 任务执行全链路追踪
- [ ] 跨服务调用追踪

---

## Phase 5: 安全加固 (第 8-10 周)

### 5.1 认证授权

**当前问题**: API 无认证，任何人可调用

**行动**:
- [ ] 实现 API Key 认证
- [ ] 添加 RBAC 权限控制
- [ ] 敏感操作二次确认

### 5.2 敏感信息保护

**行动**:
- [ ] API Key 加密存储
- [ ] 日志脱敏
- [ ] 截图数据加密

### 5.3 审计日志

**行动**:
- [ ] 记录所有敏感操作
- [ ] 支持审计日志导出
- [ ] 异常行为告警

---

## Phase 6: 高可用 (第 10-12 周)

### 6.1 服务健康检查

**行动**:
- [ ] 实现 `/health` 端点 (深度检查)
- [ ] 实现 `/ready` 端点 (就绪检查)
- [ ] 定期检查设备连接状态

### 6.2 优雅重启

**行动**:
- [ ] 实现任务优雅中断
- [ ] 状态持久化与恢复
- [ ] 零停机部署支持

### 6.3 配置热更新

**行动**:
- [ ] 支持运行时更新配置
- [ ] 不重启更新模型配置
- [ ] 不重启更新设备配置

---

## Phase 7: 规模化 (第 12-16 周)

### 7.1 多租户支持

**行动**:
- [ ] 用户/团队数据隔离
- [ ] 配额管理
- [ ] 计费集成

### 7.2 分布式架构

**行动**:
- [ ] 任务队列 (Redis/RabbitMQ)
- [ ] 设备池分片
- [ ] 负载均衡

### 7.3 管理平台

**行动**:
- [ ] 多设备批量管理
- [ ] 任务调度编排
- [ ] 报表与统计

---

## 📅 里程碑

| 阶段 | 时间 | 交付物 |
|------|------|--------|
| Phase 1 | Week 1-2 | 清理后的代码库，废弃模块标记 |
| Phase 2 | Week 2-4 | 60% 测试覆盖，CI 流程 |
| Phase 3 | Week 4-6 | 成本降低 30%，智能模型选择 |
| Phase 4 | Week 6-8 | 结构化日志，监控仪表板 |
| Phase 5 | Week 8-10 | API 认证，审计日志 |
| Phase 6 | Week 10-12 | 高可用部署方案 |
| Phase 7 | Week 12-16 | 企业级功能 |

---

## 🎯 优先级建议

对于**个人用户**:
1. Phase 1 (代码清理) - 必须
2. Phase 2 (测试) - 建议
3. Phase 3 (成本优化) - 建议

对于**企业用户**:
1. Phase 1-5 (代码清理到安全) - 必须
2. Phase 6 (高可用) - 建议
3. Phase 7 (规模化) - 可选

---

## 📝 注意事项

1. **渐进式改进**: 不要试图一次完成所有改进，每个 Phase 完成后验证效果
2. **保持兼容**: 注意 API 和配置的向后兼容性
3. **文档同步**: 每次代码改动同步更新文档
4. **用户反馈**: 定期收集用户反馈，调整优先级

---

**最后更新**: 2025-01
